<!DOCTYPE html>
<html>
<head>
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>Expense Tracker</h1>
            <div class="user-info">
                <span>Welcome, {{ current_user.username }}</span>
                <a href="{{ url_for('auth.logout') }}" class="logout-btn">Logout</a>
            </div>
        </header>

        <!-- Add Expense Form -->
        <section class="add-expense-section">
            <h2>Add Expense</h2>
            <form action="{{ url_for('add') }}" method="POST" class="expense-form">
                <input type="text" name="description" placeholder="Description" required>
                <input type="number" step="0.01" name="amount" placeholder="Amount" required>
                <input type="text" name="category" placeholder="Category" required>
                <button type="submit" class="add-btn">Add Expense</button>
            </form>
        </section>

        <!-- Category Summary -->
        <section class="category-summary-section">
            <h2>Category Summary</h2>
            {% if categories %}
            <ul class="category-summary-list">
                {% for cat, amt in categories.items() %}
                <li>{{ cat }}: ${{ "%.2f"|format(amt) }}</li>
                {% endfor %}
            </ul>
            {% else %}
                <p>No expenses added yet.</p>
            {% endif %}
        </section>

        <!-- Expenses chart-->
        <section class="expenses-chart-section">
            <h2>Expenses by Category</h2>
            <canvas id="categoryChart" width="400" height="200"></canvas>
        </section>

        <!-- Expenses Table -->
        <section class="expenses-list-section">
            <h2>Your Expenses</h2>
            {% if expenses %}
            <table class="expenses-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td>{{ expense.description }}</td>
                        <td>${{ "%.2f"|format(expense.amount) }}</td>
                        <td>{{ expense.category }}</td>
                        <td>
                            <a href="{{ url_for('edit_expense', id=expense.id) }}" class="edit-btn">Edit</a>
                                <form action="{{ url_for('delete_expense', id=expense.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="delete-btn">Delete</button>
                                </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p>No expenses added yet.</p>
            {% endif %}
        </section>
    </div>

    <!-- Chart.js Script -->
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Safely assign Jinja data to JS variable
        const dataCategories = {{ categories|default({})|tojson | safe }};
        
        const chartLabels = Object.keys(dataCategories);
        const chartData = Object.values(dataCategories);

        const ctx = document.getElementById('categoryChart').getContext('2d');

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Expenses by Category',
                    data: chartData,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(255, 159, 64, 0.6)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
    </script>

</body>
</html>
